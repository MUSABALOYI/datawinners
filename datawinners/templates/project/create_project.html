{% extends 'new_layout_wizard.html' %}
{% load i18n %}
{% block page_title %} {% trans "Create Project" %}{% endblock %}
{% block section_title %}
    <h2 class="project_title" xmlns="http://www.w3.org/1999/html">{% trans "Create a New Questionnaire" %}</h2>
{% endblock %}

{% load dw_tabs %}

{% block body %}
    {% activetab "main_nav" "projects" %}
    {{ block.super }}
{% endblock %}

{% block page_js %}
    {{ block.super }}
{#    <script type="text/javascript" src="/media/javascript/knockout.validation.min.js"></script>#}
    <script type="text/javascript" src="/media/javascript/project/sammy-latest.min.js"></script>
    <script type="text/javascript" src="/media/javascript/entity/questionnaire_view_model.js"></script>
    <script type="text/javascript" src="/media/javascript/entity/create_questionnaire.js"></script>
    <script type="text/javascript">
        var existing_questions = $.parseJSON({{existing_questions|safe}});
        var sms_preview_link = "{{ preview_links.sms_preview }}";
        var web_preview_link = "{{ preview_links.web_preview }}";
        var smart_phone_preview_link = "{{ preview_links.smart_phone_preview }}";
    </script>
    <script type="text/javascript" src="/media/javascript/csrf_token_handler.js"></script>
    <script type="text/javascript" src="/media/javascript/project/create_project.js"></script>
    <script type="text/javascript" src="/media/javascript/project/sms_preview.js"></script>
    <script type="text/javascript" src="/media/javascript/project/new_questionnaire_charcount.js"></script>
    <script type="text/javascript" src="/media/javascript/jquery.sprintf.js"></script>
    <script type="text/javascript" src="/media/javascript/warning_dialog.js"></script>
    <script type="text/javascript" src="/media/javascript/entity/questionnaire_helper.js"></script>
    <script type="text/javascript" src="/media/javascript/project/questionnaire_wizard_submit_redirect.js"></script>
    <script type="text/javascript" src="/media/javascript/entity/create_type.js"></script>
    <script type="text/javascript" src="/media/javascript/project/questionnaire_instruction_and_preview.js"></script>
    <script type="text/javascript"
            src="/media/javascript/project/questionnaire_instruction_and_preview_wizard.js"></script>
    <script type="text/javascript" src="/media/javascript/ko-binding-extensions.js"></script>

    <script type="text/javascript">
        var is_edit = {{ is_edit }};
    </script>
{% endblock %}

{% block page_scss %}
    <link href="/media/css/scss/section_questionnaire.css" rel="stylesheet"/>
    <link href="/media/css/scss/section_new_create_project.css" rel="stylesheet"/>
    <link href="/media/css/scss/section_questionnaire_preview.css" rel="stylesheet"/>
    <link href="/media/css/scss/smart_phone_instruction.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <div id="project-message-label" class="message-box none"></div>

    <input id='post_url' value="{{ post_url }}" type='hidden'/>

    {% include 'project/questionnaire_creation_options.html' %}

    <div id="questionnaire" class="clear_both" data-bind="visible: questionnaireCreationType">
        <fieldset>
            <legend>2. {% trans "Write and Edit Your Questions" %}</legend>
        </fieldset>
        <div class="line"></div>

        <form id="question_form">
            {% csrf_token %}
            <fieldset>
                <div class="questionnaire_form_header clearfix">
                    {% include 'project/questionnaire_info_indicator.html' %}
                    {% include 'project/preview_navigation.html' %}
                </div>
                <div class="questionnare_content grid_23 alpha omega">
                    <div>

                        <div id="questions-panel" class="grid_8 alpha">
                            <h4>{% trans "Questions" %}</h4>

                            <div class="add_question">
                                <a class="add_link" href="#"
                                   data-bind="click: function() { if($('#question_form').valid()) questionnaireViewModel.addQuestion(); DW.close_the_tip_on_period_question(); DW.smsPreview();}">{% trans "Add a Question" %}</a>
                            </div>
                        <div class="questions" data-bind="scrollToView: enableScrollToView">
                                 <div class="question_list" id="que_code">
                                    <ol data-bind="foreach: questions, sortable: questions" >
                                        <li data-bind="css:{question_selected:$data == $parent.selectedQuestion(),sort: true}, click: function() { if($('#question_form').valid()) $parent.changeSelectedQuestion($data);} ">
                                            <a href="#" data-bind="text: $data.display"></a>

                                            <div class="delete"
                                                 data-bind='css:{visible:$data == $parent.selectedQuestion()}'>
                                                <a href="#" class="delete_link"
                                                    data-bind="css: {visible: $data.canBeDeleted, hidden: !$data.canBeDeleted()}, click: function() {if($('#question_form').valid()){ DW.removeQuestionCheckForSubmission($data); DW.smsPreview();} else {$parent.removeIfQuestionIsSelectedQuestion($data);$('#question_form').valid();} }">{% trans "Delete" %}
                                                </a>
                                                <span>
                                                    <a data-bind="visible: $index(), click: $parent.moveQuestionUp, clickBubble: false"
                                                       class="question_action">
                                                        <span class="move-text"><img class="move-image"
                                                                                     src="/media/images/arrow_full_up_Blue.png"/>{% trans "Move Up" %}</span>
                                                    </a>
                                                    <a class="question_action"
                                                       data-bind="visible: $index() < $parent.questions().length-1, click: $parent.moveQuestionDown,clickBubble: false">
                                                        <span class="move-text move-down"><img class="move-image"
                                                                                               src="/media/images/arrow_full_down_Blue.png"/>{% trans "Move Down" %}</span>
                                                    </a>
                                                </span>
                                            </div>
                                            <span class="selected_question_arrow"
                                                  data-bind="css:{inline:$data == $parent.selectedQuestion()}"></span>
                                        </li>
                                    </ol>
                                </div>
                            </div>
                            <div class="add_question" data-bind="visible: questionnaireViewModel.questions().length>0">
                                <a class="add_link" href="#"
                                   data-bind="click: function() { if($('#question_form').valid()) questionnaireViewModel.addQuestion(); DW.close_the_tip_on_period_question(); DW.smsPreview();}">{% trans "Add a Question" %}</a>
                            </div>
                        </div>

                        <div id="question-detail-panel">
                            <div class="select_question_message"
                                 data-bind="visible: isSelectedQuestionNull">{% trans "Select a question to edit or add another question." %}</div>
                            {% include 'project/question_detail_panel.html' %}
                            {% include 'project/sms_preview.html' %}
                        </div>
                    </div>
                </div>
            </fieldset>
        </form>

        <div class="create_project">
            <div class="grid_5">
                <a id="back_to_project">{% trans "Back" %} </a>
            </div>
            <div class="grid_15 float_right">
                <div class="right_aligned_button">
                    <a href="/project/" class="cancel_project">{% trans "Cancel" %} </a>
                    {% if project.state != 'Test' %}
                        <input type="button" class="button_wizard_blue" id="save_as_draft"
                               value="{% trans "Save as Draft" %}">
                    {% endif %}
                    <input type="button" class="button_wizard_next" id="save_and_create"
                           value="{% trans "Save & Create Project" %}" data-bind="click: submit"/>
                </div>
            </div>
            <div class="clear-both"></div>
        </div>
    </div>
    {% include "warning_edit_questionnaire.html" %}
{% endblock %}
